#!/bin/bash

# Fixed start and end dates
start_date="2019-01-01"
end_date=$(date +%Y-%m-%d)  # Today's date

# Convert start and end dates to seconds since epoch
start_epoch=$(date -j -f "%Y-%m-%d" "$start_date" +%s)
end_epoch=$(date +%s)  # Current time in seconds since epoch

# Get list of namespaces with creation timestamps
namespaces=$(kubectl get namespaces -o json | jq -r '.items[] | [.metadata.name, .metadata.creationTimestamp] | @csv')

# Process namespaces and count those created within the date range and match client appcode criteria
count=0
echo "AppCode,Namespace,First Namespace Onboarded" > "$output_file"

while IFS=',' read -r namespace creationTimestamp; do
    # Extract the date portion (YYYY-MM-DD) and convert to epoch time
    creationDate=$(echo "$creationTimestamp" | cut -d'T' -f1)
    creation_epoch=$(date -j -f "%Y-%m-%d" "$creationDate" +%s)

    # Check if the creation date is within the specified range
    if [ "$creation_epoch" -ge "$start_epoch" ] && [ "$creation_epoch" -le "$end_epoch" ]; then
        # Extract app code from the namespace (first 4 letters before a hyphen)
        appcode=$(echo "$namespace" | cut -d'-' -f1)

        # Filter namespaces with appcodes where the 4th character is '0'
        if [ "${appcode:3:1}" == "0" ]; then
            # Log appcode, namespace, and creation date into the output file
            echo "$appcode,$namespace,$creationDate" >> "$output_file"
            count=$((count + 1))
        fi
    fi
done <<< "$namespaces"

echo "Total client namespaces created between $start_date and $end_date: $count"
echo "Report saved to $output_file"
